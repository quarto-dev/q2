name: TS Test Suite
on:
  push:
    branches:
      - main
      - kyoto
  pull_request:
    branches:
      - main
      - kyoto

jobs:
  test-suite:
    strategy:
      matrix:
        os: [ubuntu-latest-8x, macos-latest]
    runs-on: ${{ matrix.os }}
    
    name: Run test suite
    if: github.repository == 'quarto-dev/kyoto'
    
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      # Fix mtimes IMMEDIATELY after checkout, before anything else
      - name: Restore file modification times
        shell: bash
        run: |
          git ls-files | while read file; do
            time=$(git log -1 --format='@%ct' -- "$file" 2>/dev/null || echo '@0')
            [ "$time" != "@0" ] && touch -d "$time" "$file" 2>/dev/null || true
          done

      - name: Set up Homebrew
        if: runner.os == 'macOS'
        id: set-up-homebrew
        uses: Homebrew/actions/setup-homebrew@main

      # Consistent Rust setup for both platforms
      - name: Set up Rust nightly
        uses: dtolnay/rust-toolchain@nightly

      - name: Output rust version
        shell: bash
        run: rustup --version

      # Cache Rust AFTER toolchain is set up
      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true

      # Cache cargo-nextest and insta separately to avoid reinstalling
      - name: Install nextest
        uses: taiki-e/install-action@nextest

      - name: Install cargo-insta
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-insta

      # Pandoc setup
      - name: Set up Pandoc (Linux)
        if: runner.os == 'Linux'
        run: | 
          curl -LO https://github.com/jgm/pandoc/releases/download/3.7.0.2/pandoc-3.7.0.2-1-amd64.deb
          sudo dpkg -i pandoc-3.7.0.2-1-amd64.deb
        shell: bash

      - name: Set up Pandoc (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install pandoc
        shell: bash

      # tree-sitter setup
      - name: Set up tree-sitter CLI (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libc6-dev gcc-multilib
          curl -LO https://github.com/tree-sitter/tree-sitter/releases/download/v0.25.8/tree-sitter-linux-x86.gz
          gunzip tree-sitter-linux-x86.gz
          chmod +x tree-sitter-linux-x86
          sudo mv tree-sitter-linux-x86 /usr/local/bin/tree-sitter
    
      - name: Set up tree-sitter CLI (macOS)
        if: runner.os == 'macOS'
        run: brew install tree-sitter-cli

      # TypeScript workspace build
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install npm dependencies
        shell: bash
        run: npm ci

      # WASM build for hub-client (must happen before TypeScript build)
      - name: Set up Clang (Linux)
        if: runner.os == 'Linux'
        uses: egor-tensin/setup-clang@v1
        with:
          version: latest
          platform: x64

      - name: Set up LLVM (macOS)
        if: runner.os == 'macOS'
        run: brew install llvm
        shell: bash

      - name: Install wasm-pack
        shell: bash
        run: cargo install wasm-pack

      - name: Build WASM module
        shell: bash
        run: |
          cd crates/hub-client
          npm run build:all

      # - name: Run hub-client tests
      #   shell: bash
      #   run: |
      #     cd hub-client
      #     npm run test:ci
