name: Coverage Audit

on:
  schedule:
    # Run every Monday at 6am UTC
    - cron: '0 6 * * 1'
  workflow_dispatch:
    # Allow manual trigger

jobs:
  coverage-audit:
    runs-on: ubuntu-latest
    name: Audit coverage exclusions
    if: github.repository == 'quarto-dev/kyoto'

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Restore file modification times
        shell: bash
        run: |
          git ls-files | while read file; do
            time=$(git log -1 --format='@%ct' -- "$file" 2>/dev/null || echo '@0')
            [ "$time" != "@0" ] && touch -d "$time" "$file" 2>/dev/null || true
          done

      - name: Set up Rust nightly
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: llvm-tools-preview

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov

      - name: Install nextest
        uses: taiki-e/install-action@nextest

      - name: Set up Pandoc
        run: |
          curl -LO https://github.com/jgm/pandoc/releases/download/3.7.0.2/pandoc-3.7.0.2-1-amd64.deb
          sudo dpkg -i pandoc-3.7.0.2-1-amd64.deb

      - name: Set up tree-sitter CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y libc6-dev gcc-multilib
          curl -LO https://github.com/tree-sitter/tree-sitter/releases/download/v0.25.8/tree-sitter-linux-x86.gz
          gunzip tree-sitter-linux-x86.gz
          chmod +x tree-sitter-linux-x86
          sudo mv tree-sitter-linux-x86 /usr/local/bin/tree-sitter

      - name: Run coverage WITH exclusions
        id: coverage_with
        run: |
          set -o pipefail
          # Capture both stdout and stderr, but only process stdout for the TOTAL line
          if ! cargo llvm-cov nextest --workspace > coverage_with_output.txt 2>&1; then
            echo "::error::Coverage run with exclusions failed"
            echo "Build/test output:"
            cat coverage_with_output.txt
            echo "success=false" >> $GITHUB_OUTPUT
            echo "output=Build failed - see logs" >> $GITHUB_OUTPUT
            echo "percent=0" >> $GITHUB_OUTPUT
            exit 0  # Don't fail the job, continue to report
          fi

          OUTPUT=$(grep "^TOTAL" coverage_with_output.txt || echo "")
          if [ -z "$OUTPUT" ]; then
            echo "::warning::No TOTAL line found in coverage output"
            cat coverage_with_output.txt
            OUTPUT="NO COVERAGE DATA"
            PERCENT="0"
          else
            # Extract line coverage percentage (column 10: Lines Cover %)
            PERCENT=$(echo "$OUTPUT" | awk '{print $10}' | tr -d '%')
          fi

          echo "success=true" >> $GITHUB_OUTPUT
          echo "output<<EOF" >> $GITHUB_OUTPUT
          echo "$OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "percent=$PERCENT" >> $GITHUB_OUTPUT

      - name: Clean for rebuild
        run: cargo llvm-cov clean --workspace

      - name: Run coverage WITHOUT exclusions
        id: coverage_without
        run: |
          set -o pipefail
          # Capture both stdout and stderr, but only process stdout for the TOTAL line
          if ! cargo llvm-cov nextest --workspace --no-cfg-coverage-nightly > coverage_without_output.txt 2>&1; then
            echo "::error::Coverage run without exclusions failed"
            echo "Build/test output:"
            cat coverage_without_output.txt
            echo "success=false" >> $GITHUB_OUTPUT
            echo "output=Build failed - see logs" >> $GITHUB_OUTPUT
            echo "percent=0" >> $GITHUB_OUTPUT
            exit 0  # Don't fail the job, continue to report
          fi

          OUTPUT=$(grep "^TOTAL" coverage_without_output.txt || echo "")
          if [ -z "$OUTPUT" ]; then
            echo "::warning::No TOTAL line found in coverage output"
            cat coverage_without_output.txt
            OUTPUT="NO COVERAGE DATA"
            PERCENT="0"
          else
            # Extract line coverage percentage (column 10: Lines Cover %)
            PERCENT=$(echo "$OUTPUT" | awk '{print $10}' | tr -d '%')
          fi

          echo "success=true" >> $GITHUB_OUTPUT
          echo "output<<EOF" >> $GITHUB_OUTPUT
          echo "$OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "percent=$PERCENT" >> $GITHUB_OUTPUT

      - name: Count exclusion annotations
        id: exclusions
        run: |
          # Search for various coverage exclusion patterns:
          # - #[coverage(off)]
          # - #[cfg_attr(coverage_nightly, coverage(off))]
          # - #[cfg(not(coverage_nightly))]
          COUNT=$(grep -rE "#\[(coverage\(off\)|cfg_attr\(coverage|cfg\(.*coverage)" crates/ --include="*.rs" 2>/dev/null | wc -l || echo "0")
          echo "count=$COUNT" >> $GITHUB_OUTPUT

          # Also get the list of files with exclusions for the report
          FILES=$(grep -rlE "#\[(coverage\(off\)|cfg_attr\(coverage|cfg\(.*coverage)" crates/ --include="*.rs" 2>/dev/null || echo "")
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Calculate gap and generate report
        id: report
        run: |
          WITH="${{ steps.coverage_with.outputs.percent }}"
          WITHOUT="${{ steps.coverage_without.outputs.percent }}"
          EXCLUSIONS="${{ steps.exclusions.outputs.count }}"
          WITH_SUCCESS="${{ steps.coverage_with.outputs.success }}"
          WITHOUT_SUCCESS="${{ steps.coverage_without.outputs.success }}"

          # Calculate gap (with - without, since exclusions inflate "with" percentage)
          if [ "$WITH" != "0" ] && [ "$WITHOUT" != "0" ]; then
            GAP=$(echo "$WITH - $WITHOUT" | bc -l 2>/dev/null || echo "0")
          else
            GAP="N/A"
          fi

          echo "gap=$GAP" >> $GITHUB_OUTPUT

          # Determine overall status
          if [ "$WITH_SUCCESS" = "true" ] && [ "$WITHOUT_SUCCESS" = "true" ]; then
            STATUS="Success"
          elif [ "$WITH_SUCCESS" = "true" ] || [ "$WITHOUT_SUCCESS" = "true" ]; then
            STATUS="Partial (one run failed)"
          else
            STATUS="Failed (both runs failed)"
          fi

          # Get exclusion files
          EXCLUSION_FILES="${{ steps.exclusions.outputs.files }}"
          if [ -z "$EXCLUSION_FILES" ]; then
            EXCLUSION_FILES="No exclusions found"
          fi

          # Store GHA outputs in temp files to avoid quoting issues
          cat > /tmp/with_output.txt << 'GHA_OUTPUT_EOF'
          ${{ steps.coverage_with.outputs.output }}
          GHA_OUTPUT_EOF

          cat > /tmp/without_output.txt << 'GHA_OUTPUT_EOF'
          ${{ steps.coverage_without.outputs.output }}
          GHA_OUTPUT_EOF

          # Generate report using printf for shell variable expansion
          {
            echo "## Weekly Coverage Audit Report"
            echo ""
            echo "**Date:** $(date -u +"%Y-%m-%d")"
            echo "**Status:** ${STATUS}"
            echo ""
            echo "### Coverage Summary"
            echo ""
            echo "| Metric | Value |"
            echo "|--------|-------|"
            echo "| Line Coverage (with exclusions) | ${WITH}% |"
            echo "| Line Coverage (without exclusions) | ${WITHOUT}% |"
            echo "| Gap from exclusions | ${GAP}% |"
            echo "| Coverage exclusion annotations | ${EXCLUSIONS} |"
            echo ""
            echo "### Raw Output"
            echo ""
            echo "**With exclusions:**"
            echo "\`\`\`"
            cat /tmp/with_output.txt
            echo "\`\`\`"
            echo ""
            echo "**Without exclusions:**"
            echo "\`\`\`"
            cat /tmp/without_output.txt
            echo "\`\`\`"
            echo ""
            echo "### Exclusion Locations"
            echo ""
            echo "\`\`\`"
            echo "${EXCLUSION_FILES}"
            echo "\`\`\`"
          } > coverage-report.md

          cat coverage-report.md

          # Check if gap exceeds threshold (5%) - only if we have valid data
          THRESHOLD=5
          if [ "$GAP" != "N/A" ]; then
            EXCEEDS=$(echo "$GAP > $THRESHOLD" | bc -l 2>/dev/null || echo "0")
          else
            EXCEEDS="0"
          fi
          echo "exceeds_threshold=$EXCEEDS" >> $GITHUB_OUTPUT

      - name: Upload report artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-audit-report
          path: coverage-report.md

      - name: Create issue if gap exceeds threshold
        if: steps.report.outputs.exceeds_threshold == '1'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('coverage-report.md', 'utf8');

            // Check for existing open issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'coverage-audit'
            });

            const existingIssue = issues.data.find(i =>
              i.title.includes('Coverage exclusion gap exceeds threshold')
            );

            if (existingIssue) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `## Updated Report\n\n${report}`
              });
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'Coverage exclusion gap exceeds threshold',
                body: report,
                labels: ['coverage-audit']
              });
            }
