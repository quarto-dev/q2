# Suppress Auto-Generated Header IDs in QMD Writer

## Overview

When a header like `## project {.a-class}` is parsed, postprocessing auto-generates the ID `project` (via `autoid::auto_generated_id`). The current QMD writer then serializes this as `## project {#project .a-class}`, adding an ID that wasn't in the original source.

This causes two problems:
1. **Noisy roundtrips**: the source text changes even though the semantics are identical
2. **Spurious incremental writer rewrites**: the incremental writer sees different text and marks the block as "changed", producing unnecessary edits

## Design

### Key insight: `AttrSourceInfo.id` distinguishes auto vs explicit IDs

When the ID is auto-generated by postprocessing (`postprocess.rs:876`), the `AttrSourceInfo.id` field remains `None` because there's no source location for it — it was synthesized, not parsed from the input.

When the ID is explicitly written by the user (`## project {#my-id .a-class}`), `AttrSourceInfo.id` is `Some(source_info)` with a valid source location.

This signal survives JSON roundtrips, so it's reliable for the writer to use.

### Approach: check if auto-generated ID matches header content

In `write_header()` (`qmd.rs:537-561`), before calling `write_attr()`:

1. Check if `header.attr_source.id` is `None` (no source → auto-generated)
2. If auto-generated, compute `auto_generated_id(&header.content)` and compare to `header.attr.0`
3. If they match, write the attr **without** the ID (strip it before calling `write_attr`, or use a variant of `write_attr` that accepts an `AttrSourceInfo`)
4. If they don't match (e.g., deduplication added `-1` suffix), keep the ID since omitting it would change the semantics

### What about `is_empty_attr` check?

Currently `write_header` uses `is_empty_attr(&header.attr)` to decide whether to emit attributes at all. If we strip the auto-ID from the attr, a header like `## project` (no classes, no kvs) would have an empty attr after stripping, so no `{}` would be emitted. That's correct — `## project` should roundtrip as `## project`.

For `## project {.a-class}`, stripping the auto-ID leaves `("", ["a-class"], {})` which is non-empty, so `{.a-class}` is emitted. Correct.

### Edge cases

- **Explicit ID matching auto-generated**: `## project {#project .a-class}` — here `AttrSourceInfo.id` is `Some(...)`, so we keep the ID. This avoids losing user-specified IDs even if they happen to match the auto-generated one.
- **Deduplicated IDs**: `## project` appearing twice gets IDs `project` and `project-1`. The second one doesn't match `auto_generated_id(content)`, so it's kept. This is correct — omitting `#project-1` would change semantics.
- **No ID and no other attrs**: `## project` roundtrips as `## project` (no change). Currently it also roundtrips this way because `is_empty_attr` is checked before writing attrs.

Wait — let me verify this edge case:

```
## project
```

If the header has no explicit attrs, postprocessing still adds the auto-ID `project`, so `attr` becomes `("project", [], {})`. Currently the writer checks `is_empty_attr`, which returns `false` (because id is non-empty), so it writes `## project {#project}`. With this change, since `attr_source.id` is None, we'd strip the ID, leaving `("", [], {})`, which IS empty, so no attrs are written. Result: `## project`. This is the desired behavior.

## Work Items

### Phase 1: Tests (write first, verify they fail)

- [x] Add QMD snapshot tests: header-autoid-01 through 04 (with-class, bare, explicit-id, explicit-matching-id)
- [x] Add JSON snapshot test: header-autoid-01 (verifies AST still has auto-ID)
- [x] Add roundtrip test: header_autoid_suppressed.qmd (multiple header variants)
- [x] Verify tests fail with current code (confirmed: auto-ID appears in QMD output)

### Phase 2: Implementation

- [x] Modify `write_header()` in `qmd.rs` to compute effective attr
- [x] Check `attr_source.id.is_none()` to detect auto-generated IDs
- [x] Compare against `auto_generated_id(&header.content)` to confirm match
- [x] Strip matching auto-ID from attr before writing; `is_empty_attr` check handles the rest

### Phase 3: Full verification

- [x] All 4 manual roundtrip cases correct
- [x] All 3236 pampa tests pass
- [x] All 6394 workspace tests pass, 0 failures
- [x] `cargo build --workspace` — clean build
